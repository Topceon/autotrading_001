import create_position as cp
import market_actions as ma

LOT_SIZE = {'1000PEPEUSDT': 1, 'WLDUSDT': 1}
PRICE_PRECISION = {'1000PEPEUSDT': 7, 'WLDUSDT': 4}
DEP = 100


def average(val):
    prices = []
    for i in val:
        prices.append(float(i[4]))
    prices = prices[:-20:-5]
    return sum(prices) / len(prices)


def close_orders():
    pass


def lot_size_precision(str_precision):
    return str_precision.count('0')


def create_position(key, val, side):
    a = average(val)
    price = round(a + side * a / 100, PRICE_PRECISION[key])
    quantity = round(int(DEP / 10 / price) + LOT_SIZE[key], lot_size_precision(str(LOT_SIZE[key])))
    return {'symbol': key,
            'side': 'BUY' if side < 0 else 'SELL',
            'type': 'LIMIT',
            'price': price,
            'quantity': quantity}


def create_positions(key, val, balancer):
    orders = []
    cp.create_position({'symbol': key, 'type': 'CancelOrder'})
    if balancer[key] <= 0:
        orders.append(create_position(key, val, 0.6))
    if balancer[key] >= 0:
        orders.append(create_position(key, val, -0.6))
    # orders.append(create_position(key, val, 3.6))
    # orders.append(create_position(key, val, -3.6))
    return orders


def strategy(data, balancer):
    global DEP
    dep = float(cp.get_acc_balace())
    DEP = dep if dep > 100 else 100
    orders = []
    for key, val in data.items():
        a = create_positions(key, val, balancer)
        for i in a:
            orders.append(i)
    return orders


if __name__ == '__main__':
    data = {'1000PEPEUSDT': [
        [1714314420000, '0.0073817', '0.0073924', '0.0073760', '0.0073885', '44891431', 1714314479999, '331512.7445074',
         1316, '17662922', '130420.6019592', '0'],
        [1714314480000, '0.0073889', '0.0074011', '0.0073867', '0.0074010', '41070478', 1714314539999, '303628.0723393',
         1204, '31707147', '234413.5956993', '0'],
        [1714314540000, '0.0074011', '0.0074117', '0.0073973', '0.0074001', '48480495', 1714314599999, '358921.6340106',
         1459, '28587141', '211678.6452647', '0'],
        [1714314600000, '0.0074000', '0.0074044', '0.0073921', '0.0074016', '66518446', 1714314659999, '492072.1615614',
         1646, '22091660', '163459.7232285', '0'],
        [1714314660000, '0.0074025', '0.0074025', '0.0073928', '0.0073952', '43145755', 1714314719999, '319121.8254668',
         1136, '21252741', '157193.6032952', '0'],
        [1714314720000, '0.0073945', '0.0074198', '0.0073917', '0.0074176', '77560499', 1714314779999, '574602.7035207',
         2320, '56266066', '416876.6047684', '0'],
        [1714314780000, '0.0074180', '0.0074500', '0.0074107', '0.0074494', '174881945', 1714314839999,
         '1299173.7147893', 3875, '111598793', '829396.0039407', '0'],
        [1714314840000, '0.0074491', '0.0074736', '0.0074491', '0.0074553', '159654496', 1714314899999,
         '1191645.8893195', 4341, '88870438', '663350.5171594', '0'],
        [1714314900000, '0.0074550', '0.0074585', '0.0074365', '0.0074370', '60348217', 1714314959999, '449312.3513561',
         2040, '19029017', '141666.3443719', '0'],
        [1714314960000, '0.0074369', '0.0074369', '0.0074098', '0.0074119', '123499778', 1714315019999,
         '916327.1724653', 2750, '53615964', '397690.7154823', '0'],
        [1714315020000, '0.0074118', '0.0074347', '0.0074073', '0.0074345', '52932942', 1714315079999, '392679.6712047',
         1786, '30921501', '229438.2106002', '0'],
        [1714315080000, '0.0074345', '0.0074370', '0.0074142', '0.0074226', '38446461', 1714315139999, '285467.7473787',
         1517, '18665407', '138594.8787130', '0'],
        [1714315140000, '0.0074227', '0.0074306', '0.0074206', '0.0074291', '20831014', 1714315199999, '154676.2215060',
         777, '15439518', '114649.3456907', '0'],
        [1714315200000, '0.0074288', '0.0074288', '0.0074103', '0.0074159', '52851760', 1714315259999, '392097.5895608',
         1375, '16376723', '121519.4233075', '0'],
        [1714315260000, '0.0074161', '0.0074256', '0.0074094', '0.0074103', '53275456', 1714315319999, '395008.1416984',
         1346, '18861340', '139908.4473617', '0'],
        [1714315320000, '0.0074102', '0.0074212', '0.0074102', '0.0074195', '26663142', 1714315379999, '197764.3496217',
         988, '12519972', '92866.2975732', '0'],
        [1714315380000, '0.0074192', '0.0074216', '0.0074131', '0.0074135', '16505585', 1714315439999, '122429.9176784',
         650, '9308711', '69051.0968147', '0'],
        [1714315440000, '0.0074134', '0.0074198', '0.0074119', '0.0074165', '22393852', 1714315499999, '166081.6203524',
         875, '10085735', '74801.2956770', '0'],
        [1714315500000, '0.0074169', '0.0074232', '0.0074108', '0.0074230', '30463802', 1714315559999, '225922.0134590',
         1125, '18359924', '136174.4124216', '0'],
        [1714315560000, '0.0074221', '0.0074227', '0.0074070', '0.0074100', '28518573', 1714315619999, '211405.7435145',
         984, '8117083', '60177.6839331', '0'],
        [1714315620000, '0.0074100', '0.0074432', '0.0074035', '0.0074337', '90201417', 1714315679999, '670313.9231747',
         2496, '69352330', '515482.9148108', '0'],
        [1714315680000, '0.0074337', '0.0074368', '0.0074174', '0.0074233', '23548224', 1714315739999, '174867.4933859',
         1088, '9295067', '69027.9528899', '0'],
        [1714315740000, '0.0074230', '0.0074309', '0.0074206', '0.0074303', '18056674', 1714315799999, '134110.9990445',
         683, '9769265', '72562.8241420', '0'],
        [1714315800000, '0.0074293', '0.0074375', '0.0074244', '0.0074366', '33362390', 1714315859999, '247979.7725939',
         877, '21897374', '162797.5802523', '0'],
        [1714315860000, '0.0074352', '0.0074600', '0.0074329', '0.0074532', '53546023', 1714315919999, '398898.5825249',
         1931, '35861641', '267153.8174344', '0'],
        [1714315920000, '0.0074531', '0.0074714', '0.0074505', '0.0074637', '97867035', 1714315979999, '730465.5995353',
         2129, '52384912', '391000.8252271', '0'],
        [1714315980000, '0.0074637', '0.0074681', '0.0074444', '0.0074464', '56473744', 1714316039999, '420907.8384659',
         1569, '22772699', '169728.6815630', '0'],
        [1714316040000, '0.0074465', '0.0074615', '0.0074465', '0.0074584', '35837075', 1714316099999, '267218.7207713',
         1182, '24622995', '183595.1746337', '0'],
        [1714316100000, '0.0074579', '0.0074616', '0.0074466', '0.0074532', '58537871', 1714316159999, '436356.9712163',
         1202, '17527360', '130653.5569781', '0'],
        [1714316160000, '0.0074539', '0.0074686', '0.0074523', '0.0074575', '60796412', 1714316219999, '453549.5832819',
         1486, '38882278', '290066.0633070', '0'],
        [1714316220000, '0.0074572', '0.0074572', '0.0074465', '0.0074514', '79235309', 1714316279999, '590436.6372636',
         1692, '21577982', '160837.1127112', '0'],
        [1714316280000, '0.0074509', '0.0074608', '0.0074387', '0.0074450', '51071299', 1714316339999, '380405.3584896',
         1597, '21758186', '162117.2281735', '0'],
        [1714316340000, '0.0074450', '0.0074556', '0.0074449', '0.0074479', '21372972', 1714316399999, '159208.7941094',
         921, '10246194', '76330.4427702', '0'],
        [1714316400000, '0.0074473', '0.0074473', '0.0074294', '0.0074324', '73364929', 1714316459999, '545652.7689430',
         1999, '21385327', '159060.6676284', '0'],
        [1714316460000, '0.0074324', '0.0074652', '0.0074309', '0.0074634', '49444865', 1714316519999, '368339.3869507',
         1983, '31262697', '232854.3215869', '0'],
        [1714316520000, '0.0074642', '0.0074665', '0.0074521', '0.0074584', '35117832', 1714316579999, '261971.7776685',
         1480, '15699142', '117119.1907136', '0'],
        [1714316580000, '0.0074585', '0.0074627', '0.0074357', '0.0074377', '37088782', 1714316639999, '276278.4851257',
         1436, '13565150', '101021.6391744', '0'],
        [1714316640000, '0.0074360', '0.0074450', '0.0074304', '0.0074338', '44988575', 1714316699999, '334576.5234210',
         1565, '15153097', '112696.7003293', '0'],
        [1714316700000, '0.0074337', '0.0074337', '0.0074109', '0.0074220', '81434225', 1714316759999, '604437.6042992',
         2587, '26035154', '193257.4338421', '0'],
        [1714316760000, '0.0074218', '0.0074475', '0.0074030', '0.0074448', '118029665', 1714316819999,
         '875649.4753351', 3030, '75380296', '559446.4760470', '0'],
        [1714316820000, '0.0074446', '0.0074597', '0.0074440', '0.0074569', '63913274', 1714316879999, '476378.0246469',
         1912, '23851676', '177755.2539182', '0'],
        [1714316880000, '0.0074568', '0.0074568', '0.0074441', '0.0074524', '42027172', 1714316939999, '313070.6829386',
         1363, '19496675', '145239.8235521', '0'],
        [1714316940000, '0.0074523', '0.0074700', '0.0074518', '0.0074685', '93109238', 1714316999999, '694734.6204080',
         2388, '45133631', '336753.8841182', '0'],
        [1714317000000, '0.0074679', '0.0074712', '0.0074494', '0.0074625', '133484954', 1714317059999,
         '995991.5322752', 2326, '65821985', '491105.2558522', '0'],
        [1714317060000, '0.0074624', '0.0074671', '0.0074457', '0.0074470', '33457649', 1714317119999, '249439.2842272',
         1171, '10585947', '78934.5066822', '0'],
        [1714317120000, '0.0074470', '0.0074545', '0.0074441', '0.0074476', '24920980', 1714317179999, '185616.1934408',
         1154, '12531918', '93348.0840313', '0'],
        [1714317180000, '0.0074470', '0.0074470', '0.0074365', '0.0074467', '31595751', 1714317239999, '235096.8102192',
         1194, '17072569', '127044.8281741', '0'],
        [1714317240000, '0.0074467', '0.0074489', '0.0074389', '0.0074404', '16655045', 1714317299999, '123998.8339773',
         882, '8433235', '62798.6980536', '0'],
        [1714317300000, '0.0074405', '0.0074576', '0.0074239', '0.0074333', '95078952', 1714317359999, '707128.0222696',
         2440, '28245739', '210178.4727112', '0'],
        [1714317360000, '0.0074333', '0.0074391', '0.0074287', '0.0074287', '7558418', 1714317419999, '56199.3075128',
         344, '3892763', '28945.8881561', '0']],
        'WLDUSDT': [
            [1714314420000, '4.8122000', '4.8183000', '4.8105000', '4.8152000', '26818', 1714314479999,
             '129099.2955000',
             457, '10835', '52166.7749000', '0'],
            [1714314480000, '4.8151000', '4.8172000', '4.8130000', '4.8162000', '15946', 1714314539999, '76783.5084000',
             384, '9728', '46846.4861000', '0'],
            [1714314540000, '4.8163000', '4.8192000', '4.8147000', '4.8185000', '10956', 1714314599999, '52779.8535000',
             250, '8370', '40322.3094000', '0'],
            [1714314600000, '4.8181000', '4.8222000', '4.8150000', '4.8222000', '29089', 1714314659999,
             '140159.4197000',
             467, '15238', '73428.2640000', '0'],
            [1714314660000, '4.8222000', '4.8255000', '4.8189000', '4.8228000', '17015', 1714314719999, '82055.3888000',
             593, '10492', '50597.2892000', '0'],
            [1714314720000, '4.8227000', '4.8343000', '4.8216000', '4.8336000', '54633', 1714314779999,
             '263850.5262000',
             1009, '40348', '194862.8296000', '0'],
            [1714314780000, '4.8340000', '4.8435000', '4.8300000', '4.8430000', '48504', 1714314839999,
             '234522.3570000',
             762, '31790', '153751.8652000', '0'],
            [1714314840000, '4.8431000', '4.8580000', '4.8431000', '4.8496000', '185469', 1714314899999,
             '900004.9640000',
             2263, '78205', '379465.4050000', '0'],
            [1714314900000, '4.8496000', '4.8501000', '4.8339000', '4.8339000', '27711', 1714314959999,
             '134176.6009000',
             984, '13132', '63580.7698000', '0'],
            [1714314960000, '4.8338000', '4.8339000', '4.8242000', '4.8263000', '47261', 1714315019999,
             '228225.9895000',
             1122, '25413', '122711.8716000', '0'],
            [1714315020000, '4.8260000', '4.8341000', '4.8215000', '4.8341000', '29113', 1714315079999,
             '140532.4080000',
             835, '18739', '90469.6441000', '0'],
            [1714315080000, '4.8340000', '4.8365000', '4.8269000', '4.8317000', '20076', 1714315139999, '97005.2478000',
             636, '8996', '43465.2793000', '0'],
            [1714315140000, '4.8317000', '4.8343000', '4.8263000', '4.8304000', '18303', 1714315199999, '88393.4462000',
             501, '14071', '67954.1998000', '0'],
            [1714315200000, '4.8304000', '4.8318000', '4.8200000', '4.8229000', '26197', 1714315259999,
             '126400.0444000',
             661, '8892', '42897.6759000', '0'],
            [1714315260000, '4.8229000', '4.8292000', '4.8196000', '4.8231000', '29405', 1714315319999,
             '141850.7190000',
             746, '17405', '83957.2082000', '0'],
            [1714315320000, '4.8230000', '4.8334000', '4.8230000', '4.8326000', '19249', 1714315379999, '92969.0614000',
             619, '14401', '69549.8637000', '0'],
            [1714315380000, '4.8332000', '4.8366000', '4.8309000', '4.8324000', '14476', 1714315439999, '69977.6151000',
             382, '7495', '36229.7127000', '0'],
            [1714315440000, '4.8324000', '4.8357000', '4.8304000', '4.8339000', '6503', 1714315499999, '31430.6787000',
             226,
             '3627', '17528.8871000', '0'],
            [1714315500000, '4.8339000', '4.8357000', '4.8306000', '4.8337000', '14821', 1714315559999, '71631.1281000',
             440, '8743', '42258.1115000', '0'],
            [1714315560000, '4.8338000', '4.8417000', '4.8331000', '4.8366000', '34031', 1714315619999,
             '164632.5626000',
             587, '14473', '70015.6911000', '0'],
            [1714315620000, '4.8362000', '4.8514000', '4.8325000', '4.8473000', '35995', 1714315679999,
             '174322.2326000',
             964, '23404', '113356.0835000', '0'],
            [1714315680000, '4.8474000', '4.8496000', '4.8406000', '4.8427000', '28466', 1714315739999,
             '137865.0320000',
             569, '9056', '43860.2457000', '0'],
            [1714315740000, '4.8422000', '4.8470000', '4.8408000', '4.8445000', '11996', 1714315799999, '58107.9361000',
             398, '8038', '38937.5341000', '0'],
            [1714315800000, '4.8448000', '4.8479000', '4.8417000', '4.8442000', '14912', 1714315859999, '72252.2821000',
             533, '7957', '38557.4506000', '0'],
            [1714315860000, '4.8444000', '4.8685000', '4.8428000', '4.8645000', '89867', 1714315919999,
             '436689.9962000',
             1602, '69227', '336404.1347000', '0'],
            [1714315920000, '4.8644000', '4.8752000', '4.8622000', '4.8701000', '81392', 1714315979999,
             '396354.0587000',
             1403, '39282', '191278.7705000', '0'],
            [1714315980000, '4.8701000', '4.8718000', '4.8636000', '4.8674000', '41012', 1714316039999,
             '199616.0680000',
             805, '19708', '95924.6733000', '0'],
            [1714316040000, '4.8675000', '4.8705000', '4.8675000', '4.8687000', '18274', 1714316099999, '88976.6807000',
             480, '10169', '49514.8513000', '0'],
            [1714316100000, '4.8686000', '4.8687000', '4.8622000', '4.8628000', '44716', 1714316159999,
             '217471.2140000',
             574, '10909', '53055.7525000', '0'],
            [1714316160000, '4.8628000', '4.8703000', '4.8622000', '4.8696000', '25660', 1714316219999,
             '124868.4896000',
             486, '18181', '88479.2172000', '0'],
            [1714316220000, '4.8695000', '4.8742000', '4.8646000', '4.8727000', '33552', 1714316279999,
             '163388.6921000',
             766, '21992', '107105.4841000', '0'],
            [1714316280000, '4.8725000', '4.8737000', '4.8696000', '4.8731000', '22394', 1714316339999,
             '109099.8049000',
             478, '14114', '68761.3972000', '0'],
            [1714316340000, '4.8731000', '4.8736000', '4.8646000', '4.8646000', '17999', 1714316399999, '87628.0521000',
             509, '4199', '20441.8363000', '0'],
            [1714316400000, '4.8646000', '4.8714000', '4.8640000', '4.8685000', '53605', 1714316459999,
             '260916.7048000',
             1191, '20769', '101094.4107000', '0'],
            [1714316460000, '4.8684000', '4.8800000', '4.8684000', '4.8777000', '45709', 1714316519999,
             '222877.7685000',
             1084, '32501', '158469.3814000', '0'],
            [1714316520000, '4.8779000', '4.8815000', '4.8779000', '4.8803000', '31919', 1714316579999,
             '155751.3056000',
             733, '17707', '86408.8376000', '0'],
            [1714316580000, '4.8806000', '4.8822000', '4.8655000', '4.8666000', '95063', 1714316639999,
             '463325.2911000',
             1213, '31132', '151861.9603000', '0'],
            [1714316640000, '4.8666000', '4.8731000', '4.8664000', '4.8694000', '18775', 1714316699999, '91426.0185000',
             563, '11105', '54078.2836000', '0'],
            [1714316700000, '4.8691000', '4.8691000', '4.8631000', '4.8638000', '22461', 1714316759999,
             '109275.5309000',
             614, '9037', '43966.6168000', '0'],
            [1714316760000, '4.8639000', '4.8781000', '4.8558000', '4.8750000', '42156', 1714316819999,
             '205092.4082000',
             1021, '21190', '103110.0017000', '0'],
            [1714316820000, '4.8749000', '4.8821000', '4.8727000', '4.8813000', '27040', 1714316879999,
             '131898.4194000',
             691, '19094', '93145.7971000', '0'],
            [1714316880000, '4.8814000', '4.8822000', '4.8754000', '4.8802000', '37567', 1714316939999,
             '183344.0839000',
             651, '21932', '107054.1892000', '0'],
            [1714316940000, '4.8802000', '4.9028000', '4.8789000', '4.8995000', '92429', 1714316999999,
             '452197.5980000',
             1727, '68652', '335844.7198000', '0'],
            [1714317000000, '4.8995000', '4.9003000', '4.8795000', '4.8844000', '47783', 1714317059999,
             '233660.4091000',
             1119, '22393', '109467.5076000', '0'],
            [1714317060000, '4.8839000', '4.8855000', '4.8728000', '4.8735000', '25612', 1714317119999,
             '124943.9100000',
             718, '7481', '36491.3265000', '0'],
            [1714317120000, '4.8730000', '4.8776000', '4.8690000', '4.8704000', '50054', 1714317179999,
             '243909.4107000',
             723, '30944', '150787.6831000', '0'],
            [1714317180000, '4.8707000', '4.8720000', '4.8666000', '4.8687000', '20849', 1714317239999,
             '101511.7936000',
             586, '7753', '37754.5338000', '0'],
            [1714317240000, '4.8687000', '4.8737000', '4.8671000', '4.8671000', '10285', 1714317299999, '50088.3335000',
             306, '4338', '21127.4880000', '0'],
            [1714317300000, '4.8671000', '4.8719000', '4.8516000', '4.8570000', '54330', 1714317359999,
             '264084.4333000',
             1259, '17648', '85807.6054000', '0'],
            [1714317360000, '4.8569000', '4.8595000', '4.8542000', '4.8542000', '11287', 1714317419999, '54817.7405000',
             211, '4293', '20856.3917000', '0']]}
    COIN_PAIR = ['1000PEPEUSDT', 'WLDUSDT']
    BALANCER = {COIN: 0 for COIN in COIN_PAIR}
    print(strategy(data, BALANCER)[0]['quantity'])
